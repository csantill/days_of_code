---
title: "Days of Code"
author: "Carlos Santillan"
date: "February 10, 2018"
output: html_document
---

  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd("F:/Development/days_of_code")
```

### Load R Libraries


```{r libraries}

library(tidyverse)
library(ggplot2)
library(fiftystater)

data("fifty_states") # this line is optional due to lazy data loading
```

### Load the data
Load CDC data 
Dataset: Underlying Cause of Death, 1999-2016

Group By: State, Year, Month, ICD Chapter

ICD-10 Codes: 

* X40 (Accidental poisoning by and exposure to nonopioid analgesics, antipyretics and antirheumatics)
* X41 (Accidental poisoning by and exposure to antiepileptic, sedative-hypnotic, antiparkinsonism and psychotropic drugs, not elsewhere classified)
* X42 (Accidental poisoning by and exposure to narcotics and psychodysleptics [hallucinogens], not elsewhere classified)
* X43 (Accidental poisoning by and exposure to other drugs acting on the autonomic nervous system)
* X44 (Accidental poisoning by and exposure to other and unspecified drugs, medicaments and biological substances) 
* X60 (Intentional self-poisoning by and exposure to nonopioid analgesics, antipyretics and antirheumatics)
* X61 (Intentional self-poisoning by and exposure to antiepileptic, sedative-hypnotic, antiparkinsonism and psychotropic drugs, not elsewhere classified)
* X62 (Intentional self-poisoning by and exposure to narcotics and psychodysleptics [hallucinogens], not elsewhere classified)
* X63 (Intentional self-poisoning by and exposure to other drugs acting on the autonomic nervous system) 
* X64 (Intentional self-poisoning by and exposure to other and unspecified drugs, medicaments and biological substances) 
* Y10 (Poisoning by and exposure to nonopioid analgesics, antipyretics and antirheumatics, undetermined intent) 
* Y11 (Poisoning by and exposure to antiepileptic, sedative-hypnotic, antiparkinsonism and psychotropic drugs, not elsewhere classified, undetermined intent), 
* Y12 (Poisoning by and exposure to narcotics and psychodysleptics [hallucinogens], not elsewhere classified, undetermined intent)
* Y13 (Poisoning by and exposure to other drugs acting on the autonomic nervous system, undetermined intent)
* Y14 (Poisoning by and exposure to other and unspecified drugs, medicaments and biological substances, undetermined intent)

Source: 

Centers for Disease Control and Prevention, National Center for Health Statistics. Underlying Cause of Death 1999-2016 on CDC WONDER Online Database, released December, 2017. Data are from the Multiple Cause of Death Files, 1999-2016, as 
 compiled from data provided by the 57 vital statistics jurisdictions through the Vital Statistics Cooperative Program. Accessed at http://wonder.cdc.gov/ucd-icd10.html on Feb 10, 2018 4:36:12 PM 


```{r loaddata, echo=FALSE}

cdc.state.data        <- read_tsv("CDC/data/statefull.txt")
colnames(cdc.state.data) <- make.names(colnames(cdc.state.data))
cdc.state.data$Notes  <- cdc.state.data$Notes <- NULL
cdc.state.data$Deaths <- as.integer(cdc.state.data$Deaths)
cdc.state.data <- cdc.state.data %>% separate(Month.Code,c("yr","Month.Code"))
cdc.state.data$yr <- as.character(cdc.state.data$Year)
cdc.state.data$YearMonth <- paste(cdc.state.data$yr , cdc.state.data$Month.Code,sep="-")
#cdc.state.data <- cdc.state.data %>% mutate(YearMonth= paste(toString(Year) , "-" ,Month.Code))

cdc.state.data <- subset(cdc.state.data,select=c("State","YearMonth","Year","Month.Code","Deaths"))

#save the RDS
saveRDS(cdc.state.data,"cdc.state.data.rds")


```

### Exploration 

```{r explore, echo=FALSE}
str(cdc.state.data)
head(cdc.state.data)
summary(cdc.state.data)
print(cdc.state.data %>% filter(Year==2016) %>% select(Deaths) %>%sum())
print("Deaths reported in 2016 ")
print( cdc.state.data %>% filter(Year==2016,State=="Texas") %>% select(Deaths) %>%sum())
#print(cdc.state.data %>% filter(Year==2016,State=="Texas") %>% group_by(Month.Code)  %>% select(Deaths)) %>%sum()
```



```{r explore2016, echo=FALSE}
grp_state <- cdc.state.data %>% filter(Year==2016)%>% group_by(State,YearMonth)%>% select(Deaths)
summary(grp_state)

```



```{r plottexas, echo=FALSE}
grp_state <- cdc.state.data %>% group_by(State,YearMonth)%>% select(Deaths)

tx <- filter(grp_state,State=="Texas")
head(tx)
summarise(tx)

ggplot(tx,aes(x=YearMonth, y=Deaths))+
  geom_point()  +
  ggtitle("Deaths attributed to opiods for the state of Texas","1999-2016")

ggplot(tx,aes(x=YearMonth, y=Deaths,group=1))+
  geom_line(stat="identity") +
  stat_smooth() +
  ggtitle("Deaths attributed to opiods for the state of Texas","1999-2016")

#ggplot(tx,aes(x=Month.Code, y=Deaths))+
#  geom_point()
#
#grp_state2 <-grp_state %>%group_by(State)

#grp_state2 <-grp_state %>%group_by(State)%>% summarise(Deaths= sum(Deaths))

#ggplot(tx,aes(x=Month.Code, y=Deaths))+
#  geom_line()



```


```{r plottus, echo=FALSE}
grp_us <- cdc.state.data %>% group_by(Year)%>% select(Deaths) %>%summarise(Deaths= sum(Deaths))

#tx <- filter(grp_state,State=="Texas")
head(grp_us)
#summarise(tx)

ggplot(grp_us,aes(x=Year, y=Deaths))+
  geom_point()  +
  ggtitle("Deaths attributed to opiods in the United States","1999-2016")

ggplot(grp_us,aes(x=Year, y=Deaths,group=1))+
  geom_line() +
  stat_smooth() +
  ggtitle("Deaths attributed to opiods in the United States","1999-2016")

#ggplot(tx,aes(x=Month.Code, y=Deaths))+
#  geom_point()
#
#grp_state2 <-grp_state %>%group_by(State)

#grp_state2 <-grp_state %>%group_by(State)%>% summarise(Deaths= sum(Deaths))

#ggplot(tx,aes(x=Month.Code, y=Deaths))+
#  geom_line()



```

```{r plotmap, echo=FALSE}

grp_state2 <-grp_state %>%group_by(State)%>% summarise(Deaths= sum(Deaths))
grp_state2$State <- tolower(grp_state2$State)

p <- ggplot(grp_state2, aes(map_id = State)) + 
  # map points to the fifty_states shape data
  scale_fill_gradient(low="white", high="red")+
# Diverging color scheme
  geom_map(aes(fill = Deaths), map = fifty_states) +
  
  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  labs(x = "", y = "") +
  theme(legend.position = "bottom", 
        panel.background = element_blank())


p + fifty_states_inset_boxes() 

```


